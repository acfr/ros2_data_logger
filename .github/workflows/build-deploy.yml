name: Build and Deploy ROS2 Data Logger

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ros_distro:
        description: 'ROS Distribution'
        required: true
        default: 'jazzy'
        type: choice
        options:
          - jazzy

env:
  ROS_DISTRO: jazzy

jobs:
  build:
    name: Build Debian Package
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        ros_distro: [jazzy]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: src/ros2_data_logger
      
      - name: Set up ROS 2 ${{ matrix.ros_distro }}
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ matrix.ros_distro }}
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-bloom \
            python3-rosdep \
            python3-colcon-common-extensions \
            dpkg-dev \
            debhelper \
            fakeroot
          
          # Initialize rosdep
          sudo rosdep init || true
          rosdep update
      
      - name: Install package dependencies
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          rosdep install --from-paths src --ignore-src -r -y
      
      - name: Build package with colcon
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          colcon build --packages-select ros2_data_logger --cmake-args -DCMAKE_BUILD_TYPE=Release
      
      - name: Build Debian package
        run: |
          cd src/ros2_data_logger
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          
          # Generate Debian files with bloom
          bloom-generate rosdebian --os-name ubuntu --os-version noble --ros-distro ${{ matrix.ros_distro }}
          
          # Build the package
          fakeroot debian/rules binary
          
          # Create output directory
          mkdir -p ../../debian_packages
          
          # Move generated .deb files
          find ../.. -maxdepth 1 -name "ros-${{ matrix.ros_distro }}-ros2-data-logger*.deb" -exec mv {} ../../debian_packages/ \;
          
          # List built packages
          ls -lh ../../debian_packages/
      
      - name: Upload Debian package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros2-data-logger-${{ matrix.ros_distro }}-deb
          path: debian_packages/*.deb
          retention-days: 30
      
      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: debian_packages/*.deb
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Deploy to avocado.acfr.usyd.edu.au
    runs-on: ubuntu-24.04
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        ros_distro: [jazzy]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Debian package artifacts
        uses: actions/download-artifact@v4
        with:
          name: ros2-data-logger-${{ matrix.ros_distro }}-deb
          path: debian_packages
      
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AVOCADO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H avocado.acfr.usyd.edu.au >> ~/.ssh/known_hosts
      
      - name: Deploy to avocado server
        env:
          DEPLOY_USER: ${{ secrets.AVOCADO_USER }}
          DEPLOY_HOST: avocado.acfr.usyd.edu.au
          REMOTE_BASE_PATH: /data/www/EHM/datasets/ubuntu-repo
        run: |
          # Create remote directory
          ssh ${DEPLOY_USER}@${DEPLOY_HOST} "sudo mkdir -p ${REMOTE_BASE_PATH}/${{ matrix.ros_distro }} && sudo chown -R ${DEPLOY_USER}: ${REMOTE_BASE_PATH}"
          
          # Copy packages
          scp debian_packages/*.deb ${DEPLOY_USER}@${DEPLOY_HOST}:${REMOTE_BASE_PATH}/${{ matrix.ros_distro }}/
          
          # Update repository index
          ssh ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            cd ${REMOTE_BASE_PATH}/${{ matrix.ros_distro }}
            
            # Install dpkg-dev if needed
            if ! command -v dpkg-scanpackages &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y dpkg-dev
            fi
            
            # Generate package index
            dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz
            dpkg-scanpackages . /dev/null > Packages
            
            # Create Release file
            cat > Release << RELEASE_EOF
          Origin: ACFR
          Label: ROS2 Data Logger Repository
          Suite: stable
          Codename: ${{ matrix.ros_distro }}
          Architectures: amd64 arm64
          Components: main
          Description: ACFR ROS2 Data Logger packages
          Date: $(date -R)
          RELEASE_EOF
          EOF
      
      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“¦ Repository URL: https://data.acfr.usyd.edu.au/ubuntu-repo/${{ matrix.ros_distro }}"

  test-install:
    name: Test Package Installation
    runs-on: ubuntu-24.04
    needs: build
    strategy:
      matrix:
        ros_distro: [jazzy]
    
    steps:
      - name: Set up ROS 2 ${{ matrix.ros_distro }}
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ matrix.ros_distro }}
      
      - name: Download Debian package artifacts
        uses: actions/download-artifact@v4
        with:
          name: ros2-data-logger-${{ matrix.ros_distro }}-deb
          path: debian_packages
      
      - name: Install package
        run: |
          sudo apt-get update
          sudo apt-get install -y ./debian_packages/*.deb
      
      - name: Verify installation
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          
          # Check if package files are installed
          if [ -d "/opt/ros/${{ matrix.ros_distro }}/share/ros2_data_logger" ]; then
            echo "âœ… Package installed successfully"
            ls -la /opt/ros/${{ matrix.ros_distro }}/share/ros2_data_logger
          else
            echo "âŒ Package installation failed"
            exit 1
          fi
          
          # Verify launch files exist
          if [ -f "/opt/ros/${{ matrix.ros_distro }}/share/ros2_data_logger/launch/simple_logger.launch.py" ]; then
            echo "âœ… Launch files found"
          else
            echo "âŒ Launch files missing"
            exit 1
          fi
